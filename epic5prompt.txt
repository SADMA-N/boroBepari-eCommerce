git checkout main
git pull origin main
git checkout -b epic-5-order-management
```

---

### **Subtask 5.1: Order Data Models & API Routes**

**Prompt for Gemini:**
```
Create data models and API structure for order management.

Requirements:

1. TypeScript types:
   - Order entity:
     * id, orderNumber (formatted: BO-2024-XXXXX)
     * buyerId, items: OrderItem[], totalAmount
     * deliveryAddress, paymentMethod, paymentStatus
     * orderStatus, createdAt, updatedAt
     * estimatedDelivery, actualDelivery
     * invoiceUrl, trackingNumber, courierName
   
   - OrderItem:
     * productId, productName, image
     * quantity, unitPrice, lineTotal
     * supplierId, supplierName
   
   - OrderStatus enum:
     * placed | confirmed | processing | shipped | out_for_delivery | delivered | cancelled | returned

2. API routes (create placeholder):
   - GET /api/orders/buyer/:buyerId - Get buyer's orders
   - GET /api/orders/:orderId - Get order details
   - PATCH /api/orders/:orderId/status - Update order status (supplier/admin)
   - POST /api/orders/:orderId/reorder - Reorder items
   - GET /api/orders/:orderId/invoice - Generate/download invoice PDF
   - POST /api/orders/:orderId/track - Get tracking updates

3. Order utilities:
   - Generate formatted order number
   - Calculate estimated delivery (business days)
   - Order status transition rules (placed → confirmed → shipped, etc.)
   - Invoice generation logic

Place files following TanStack Start structure with clear documentation.
```

**Commit Message:** `feat(epic-5): add order data models and API routes structure`

---

### **Subtask 5.2: Order History Page**

**Prompt for Gemini:**
```
Create the buyer order history page with filtering and search.

Requirements:

1. Create `OrderHistoryPage.tsx`:
   - Route: /buyer/orders
   - Display all buyer's orders in descending date order (newest first)

2. Order List Display:
   - Card/table layout with:
     * Order number (clickable to detail page)
     * Order date
     * Items count (e.g., "3 items")
     * Total amount (₹)
     * Order status badge (color-coded)
     * Thumbnail images of first 3 products
   
3. Filtering Tabs:
   - All Orders
   - Active (placed, confirmed, processing, shipped)
   - Delivered
   - Cancelled/Returned
   - Update count badges on tabs

4. Search & Sort:
   - Search bar: Search by order number, product name
   - Sort dropdown: 
     * Date (Newest first / Oldest first)
     * Amount (High to Low / Low to High)
     * Status

5. Pagination:
   - Show 10-20 orders per page
   - Pagination controls at bottom
   - Or infinite scroll option

6. Empty States:
   - "No orders yet" for new users
   - "No orders found" for filters with no results
   - CTA button: "Start Shopping"

Use responsive design with mobile-optimized card layout.
```

**Commit Message:** `feat(epic-5): create order history page with filtering and search`

---

### **Subtask 5.3: Order Detail Page**

**Prompt for Gemini:**
```
Create comprehensive order detail page.

Requirements:

1. Create `OrderDetailPage.tsx`:
   - Route: /buyer/orders/:orderId
   - Hero section:
     * Order number (large, prominent)
     * Order status badge
     * Order date and time
   
2. Order Items Section:
   - List all ordered items (grouped by supplier if multi-supplier)
   - Each item shows:
     * Product image (clickable to PDP)
     * Product name
     * Quantity ordered
     * Unit price
     * Line total
     * "Write Review" button (if delivered)

3. Delivery Information:
   - Full delivery address
   - Contact phone number
   - Estimated delivery date
   - Actual delivery date (if delivered)
   - Delivery instructions (if any)

4. Payment Information:
   - Payment method used
   - Payment status (Paid / Deposit Paid / Pending)
   - Amount paid
   - Balance due (if deposit payment)
   - Transaction ID (if available)
   - PO Number (if provided)

5. Order Summary:
   - Subtotal
   - Delivery charges
   - Discount applied (if any)
   - Total amount

6. Action Buttons:
   - "Track Order" (prominent, if shipped)
   - "Download Invoice" (PDF download)
   - "Reorder" (add all items to cart)
   - "Cancel Order" (if status allows)
   - "Get Help" / "Contact Support"

7. Supplier Information:
   - For each supplier:
     * Supplier name + verification badge
     * "Contact Supplier" button
     * Items from this supplier

Add breadcrumb navigation and ensure mobile-responsive layout.
```

**Commit Message:** `feat(epic-5): create order detail page with comprehensive information`

---

### **Subtask 5.4: Order Status Tracking Timeline**

**Prompt for Gemini:**
```
Create visual order status tracking timeline component.

Requirements:

1. Create `OrderStatusTimeline.tsx` component:
   - Visual stepper/timeline showing order progression
   - Stages:
     1. Order Placed
     2. Confirmed by Supplier
     3. Processing/Packing
     4. Shipped
     5. Out for Delivery
     6. Delivered
   
2. Timeline UI:
   - Horizontal stepper (desktop) / Vertical list (mobile)
   - Each stage shows:
     * Stage name
     * Icon/checkmark
     * Date and time (when reached)
     * Status indicator (completed/current/pending)
   - Current stage highlighted with accent color
   - Completed stages: Green checkmark
   - Pending stages: Grey/unfilled

3. Dynamic Timeline:
   - Hide "Out for Delivery" if not applicable
   - Show "Cancelled" status if order cancelled
   - Add "Returned" status if order returned
   
4. Tracking Details (when shipped):
   - Courier/logistics partner name
   - Tracking number (copyable)
   - "Track on courier website" link (opens courier tracking page)
   - Expected delivery date

5. Real-time Updates:
   - Show last updated timestamp
   - "Refresh" button to check for updates
   - Auto-refresh every 5 minutes (configurable)
   - Show loader during refresh

6. Notifications:
   - Display notification: "Order status updated: Shipped"
   - Link to courier tracking from notification

Use clean, modern design with smooth animations for status transitions.
```

**Commit Message:** `feat(epic-5): add order status tracking timeline component`

---

### **Subtask 5.5: Reorder Functionality**

**Prompt for Gemini:**
```
Implement one-click reorder feature for completed orders.

Requirements:

1. Reorder Button:
   - Position: Order detail page, prominent placement
   - Label: "Reorder" or "Buy Again"
   - Icon: Refresh/repeat icon

2. Reorder Logic:
   - Fetch all items from original order
   - Check each item:
     * Product still available?
     * Current price same/different?
     * Stock available?
     * Supplier still active?
   
3. Price Change Handling:
   - If price changed:
     * Show modal: "Prices have changed since your last order"
     * Display table:
       | Product | Old Price | New Price | Difference |
     * "Add to Cart with New Prices" button
     * "Cancel" button
   - If price same:
     * Directly add to cart
     * Show success toast

4. Unavailable Items:
   - If product out of stock:
     * Show warning: "Some items are unavailable"
     * List unavailable items
     * Options:
       a) "Add available items only"
       b) "View alternatives" (suggest similar products)
       c) "Notify when back in stock"

5. Multi-Supplier Reorder:
   - If original order had multiple suppliers:
     * Show breakdown by supplier
     * Allow selective reorder (checkboxes per supplier)
     * "Reorder from [Supplier Name]" buttons

6. Post-Reorder Actions:
   - Redirect to cart page
   - Highlight newly added items
   - Show notification: "X items added from Order #BO-2024-XXXX"

7. Analytics Tracking:
   - Track reorder events
   - Monitor reorder rate for products
   - Popular reorder times

Handle all edge cases gracefully with clear user communication.
```

**Commit Message:** `feat(epic-5): implement reorder functionality with price validation`

---

### **Subtask 5.6: Invoice Generation & Download**

**Prompt for Gemini:**
```
Create professional invoice PDF generation and download.

Requirements:

1. Invoice PDF Template:
   - Header:
     * BoroBepari logo
     * "TAX INVOICE" heading
     * Invoice number (INV-2024-XXXXX)
     * Invoice date
   
   - Company Details:
     * BoroBepari business address
     * GST/Tax ID (if applicable)
     * Contact information
   
   - Buyer Details:
     * Buyer name
     * Delivery address
     * Phone number
     * Email
   
   - Order Details:
     * Order number
     * Order date
     * Payment method

2. Itemized List:
   - Table with columns:
     * S.No | Product Name | Quantity | Unit Price | Total
   - Subtotal
   - Delivery charges
   - Discount (if applied)
   - Tax breakdown (if applicable)
   - **Grand Total** (bold)

3. Payment Information:
   - Amount paid
   - Balance due (if deposit payment)
   - Payment status
   - Transaction reference

4. Footer:
   - Terms and conditions (brief)
   - Return policy link
   - "Thank you for your business" message

5. PDF Generation:
   - Use library: jsPDF or react-pdf
   - Generate on button click
   - Download as: Invoice_BO-2024-XXXXX.pdf
   - Show loading state during generation

6. Invoice Storage:
   - Save generated invoice URL in order record
   - Allow re-download without regeneration
   - Ensure invoices are accessible from order history

7. Email Invoice:
   - Option to email invoice to buyer
   - "Email Invoice" button
   - Sends to registered email address

Design professional, print-friendly invoice layout with proper formatting.
```

**Commit Message:** `feat(epic-5): add invoice PDF generation and download`

---

### **Subtask 5.7: Order Cancellation Flow**

**Prompt for Gemini:**
```
Implement order cancellation with business rules and refund handling.

Requirements:

1. Cancel Order Button:
   - Visible only if order status allows (placed, confirmed)
   - Hidden once shipped
   - Warning icon/color

2. Cancellation Modal:
   - Heading: "Cancel Order #BO-2024-XXXXX?"
   - Reason selection (dropdown):
     * Ordered by mistake
     * Found better price elsewhere
     * Changed my mind
     * Delivery time too long
     * Other (with text input)
   - Confirmation message:
     * "Are you sure you want to cancel this order?"
     * Explain refund process
   - "Cancel Order" button (destructive)
   - "Keep Order" button

3. Cancellation Logic:
   - Check cancellation eligibility:
     * Allowed: placed, confirmed
     * Not allowed: processing, shipped, delivered
   - If payment made:
     * Full payment → Full refund
     * Deposit → Refund deposit
     * Escrow → Refund from escrow
   - Update order status to "cancelled"

4. Refund Processing:
   - Show refund timeline:
     * "Refund will be processed in 3-5 business days"
   - Send refund to original payment method
   - Email confirmation of cancellation and refund

5. Post-Cancellation:
   - Order status badge: "Cancelled"
   - Show cancellation reason on order detail
   - Disable reorder button
   - "Shop Similar Products" CTA

6. Supplier Notification:
   - Notify supplier of cancellation
   - Remove from supplier's order queue

7. Edge Cases:
   - Partial cancellation (not implemented initially)
   - Cancellation after partial shipment
   - Multiple cancellation attempts

Add clear messaging and user-friendly error handling.
```

**Commit Message:** `feat(epic-5): implement order cancellation with refund logic`

---

### **Subtask 5.8: Order Notifications Integration**

**Prompt for Gemini:**
```
Integrate notifications for order status updates.

Requirements:

1. Notification Triggers:
   Buyer receives notifications when:
   - Order placed successfully
   - Order confirmed by supplier
   - Order shipped (with tracking)
   - Out for delivery
   - Delivered successfully
   - Order cancelled (by buyer/supplier)
   - Refund processed
   
2. Notification Channels:
   - In-app notification (bell icon)
   - Email notification
   - SMS notification (for critical updates: shipped, delivered)
   - Push notification (if mobile app)

3. Notification Content:
   Each notification includes:
   - Order number
   - Status change
   - Next expected action (if any)
   - Link to order detail page
   
   Example Email:
```
   Subject: Your order #BO-2024-12345 has been shipped!
   
   Hi [Name],
   
   Good news! Your order has been shipped and is on its way.
   
   Tracking Number: XYZ123456
   Courier: BlueDart
   Estimated Delivery: Feb 7, 2024
   
   [Track Order Button]
```

4. Notification Preferences:
   - Settings page: /buyer/notifications
   - Toggle for each notification type
   - Choose preferred channels (email/SMS/push)
   - Frequency settings (immediate/daily digest)

5. Real-time Notifications:
   - Use WebSocket or polling for in-app updates
   - Show toast notification when order status changes
   - Update order list in real-time
   - Badge count on orders tab

6. Notification History:
   - View all notifications
   - Filter by order
   - Mark as read/unread
   - Archive old notifications

Create reusable notification components and email templates.
```

**Commit Message:** `feat(epic-5): integrate order status notifications across channels`

---

### **Subtask 5.9: Stock Alert Notifications**

**Prompt for Gemini:**
```
Implement stock alert notifications for wishlisted items (from Epic 1).

Requirements:

1. Stock Alert Subscription:
   - On product page, if out of stock:
     * "Notify Me When Available" button
     * Opens modal to collect:
       - Email (pre-filled if logged in)
       - Phone number (optional)
   - Save stock alert preference

2. Alert Trigger:
   - When product restocks (supplier updates inventory):
     * Check all users who subscribed
     * Send notifications immediately

3. Notification Content:
   Email:
```
   Subject: [Product Name] is back in stock!
   
   The product you were waiting for is now available.
   
   [Product Image]
   Product: [Name]
   Price: ₹X
   MOQ: X units
   
   [Shop Now Button]
```
   
   SMS:
```
   [Product Name] is back in stock on BoroBepari! 
   Order now: [Short Link]
```

4. In-app Notification:
   - Toast notification when user logs in
   - Notification panel entry
   - Direct link to product page

5. Alert Management:
   - User can view all stock alerts
   - Unsubscribe from specific alerts
   - Auto-remove alert after 30 days

6. Wishlist Integration:
   - Auto-create stock alert for wishlisted out-of-stock items
   - Remove from wishlist after purchase

This feature drives re-engagement and conversions for previously unavailable products.
```

**Commit Message:** `feat(epic-5): add stock alert notifications for wishlisted items`

---

### **Epic 5 Final Tasks**

**Subtask 5.10: Order Management Testing & Edge Cases**

**Prompt for Gemini:**
```
Add comprehensive testing and edge case handling for order management.

Tasks:

1. Order Status Edge Cases:
   - Order cancelled after shipment
   - Delivery failed/returned
   - Multiple status updates in quick succession
   - Tracking number not available from courier
   - Delayed delivery beyond estimate

2. Data Consistency:
   - Ensure order totals match invoice
   - Verify item prices locked at checkout
   - Check quantity matches between order and delivery
   - Validate refund amounts

3. Performance:
   - Lazy load order history (infinite scroll)
   - Cache order details
   - Optimize invoice PDF generation (don't regenerate)
   - Debounce tracking refresh requests

4. Security:
   - Ensure user can only view own orders
   - Validate order ownership before cancellation
   - Secure invoice download URLs (signed URLs)
   - Protect against CSRF in order actions

5. Accessibility:
   - Screen reader support for order timeline
   - Keyboard navigation in order list
   - High contrast status badges
   - Alt text for product images

6. Mobile Optimization:
   - Collapsible order items section
   - Sticky "Track Order" button
   - Swipeable status timeline
   - Bottom sheet for cancellation modal

7. Error Handling:
   - Network errors during tracking refresh
   - Invoice generation failures
   - Reorder with unavailable items
   - Failed refund processing

Add loading states, error boundaries, and comprehensive logging.